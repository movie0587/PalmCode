clc; clear all;
%% 参数设置
thres_extraction_bw=0.31;
thres_resize=0.2;
imagePath='palmImage/rtest_51.jpg';

%% 手掌提取
src=imread(imagePath);
src=imresize(src,thres_resize);
% src_gray=rgb2gray(src);
% figure('name','原图'),imshow((src)),title('原图');

palm=PalmExtraction(src,thres_extraction_bw);
% figure;
% subplot(1,2,1),imshow(palm);
% palm=imbinarize(rgb2gray(palm),0.25);
% % subplot(1,2,1),imshow(palm);
% palm=palm.*bw_filter(palm,1);
% subplot(1,2,2),imshow(palm);
% figure('name','提取出的手掌'),imshow(palm),title('提取出的手掌');
% figure,imshow(palm.*otusThreshold(palm)),title('otus');
%% 进一步提取ROI，分出手指部分与下面的手掌部分
palm_bw = imbinarize(rgb2gray(palm),0.25);
% palm2 = bwAreaFilter(palm_bw,20);
% figure,imshow(palm_bw);
% hold on;

% 中间分割线
[midLeft, midRight] = findSegmentLine(palm_bw);
% plot(midLeft.x, midLeft.y, 'rO');
% plot(midRight.x, midRight.y, 'r*');
% 底部的线
[bottomLeft, bottomRight] = findBottomLine(palm_bw,midLeft,midRight);
% plot(bottomLeft.x, bottomLeft.y, 'rO');
% plot(bottomRight.x, bottomRight.y, 'r*');
% 顶部的线
[topLeft, topRight] = findTopLine(palm_bw,midLeft,midRight);
% plot(topLeft.x, topLeft.y, 'rO');
% plot(topRight.x, topRight.y, 'r*');
%% Gabor滤波
%手指部分
palm_gray = rgb2gray(palm);
% palm_gray_finger = palm_gray(topLeft.y:midLeft.y,midLeft.x:midRight.x);
% % figure,imshow(palm_gray_finger);
% [row,col] = size(palm_gray_finger);
% palm_finger_gabor = zeros(size(palm_gray_finger));
% 
% gaborArray = gabor([11],[80 90 100],'SpatialFrequencyBandwidth',1.5,'SpatialAspectRatio',3.5);
% gaborMag = imgaborfilt(palm_gray_finger,gaborArray);
% 
% for i=1:row
%     for j=1:col
%         palm_finger_gabor(i,j)=min(gaborMag(i,j,:));
%     end
% end
% % figure,imshow(palm_finger_gabor);
% palm_finger_gabor_bw = imbinarize(palm_finger_gabor,0.32);
% palm_finger_gabor_bw = bwAreaFilter(palm_finger_gabor_bw,15);
% figure,imshow(palm_finger_gabor_bw);

%手掌部分
palm_gray_main = palm_gray(midLeft.y:bottomLeft.y,midLeft.x:midRight.x);
% figure,imshow(palm_gray_main);
[row1,col1] = size(palm_gray_main);
palm_main_gabor = zeros(size(palm_gray_main));

gaborArray = gabor([11],[0 45 60 90 135 330],'SpatialFrequencyBandwidth',1.5,'SpatialAspectRatio',3.5);
gaborMag = imgaborfilt(palm_gray_main,gaborArray);

for i=1:row1
    for j=1:col1
        palm_main_gabor(i,j)=min(gaborMag(i,j,:));
    end
end
% figure,imshow(palm_finger_gabor);
palm_main_gabor_bw = imbinarize(palm_main_gabor,0.70);
palm_main_gabor_bw = bwAreaFilter(palm_main_gabor_bw,40);
figure,imshow(palm_main_gabor_bw);
%%
% c=corner(rgb2gray(test),10);
% figure,imshow(test);
% hold on;
% plot(c(:,1),c(:,2),'r*');
